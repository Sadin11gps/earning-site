<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Task 1 - Student Best Income</title>
<style>
  body { font-family: Arial, sans-serif; background:#f0f9ff; text-align:center; padding:20px; margin:0; }
  header { background:#3b82f6; color:#fff; padding:12px; font-size:20px; font-weight:700; }
  .banner { background:#fde68a; color:#92400e; padding:12px; border-radius:8px; margin:18px auto; width:95%; max-width:720px; text-align:left; }
  .banner .actions { float:right; }
  .btn { display:inline-block; padding:8px 12px; margin-left:8px; border:none; border-radius:6px; cursor:pointer; font-weight:700; }
  .btn-open { background:#2563eb; color:#fff; }
  .btn-copy { background:#10b981; color:#fff; }
  .container { background:#e0f2fe; padding:18px; margin:16px auto; border-radius:10px; width:95%; max-width:720px; box-sizing:border-box; }
  label { display:block; text-align:left; margin:10px 0 6px; font-weight:600; }
  input[type="file"] { width:100%; }
  input[type="text"], input[type="email"] { width:100%; padding:10px; border-radius:6px; border:1px solid #cbd5e1; box-sizing:border-box; }
  .note { font-size:14px; color:#065f46; margin:8px 0 14px; }
  .payline { font-weight:700; margin:8px 0; }
  .submit-btn { background:#10b981; color:#fff; padding:12px 18px; margin-top:12px; border:none; border-radius:8px; font-weight:800; cursor:pointer; }
  .submit-btn[disabled] { opacity:0.6; cursor:not-allowed; }
  .success { color:green; font-weight:700; margin-top:10px; }
  .error { color:red; font-weight:700; margin-top:10px; }
  .status-badge { display:inline-block; padding:6px 10px; border-radius:8px; font-weight:700; }
  .status-pending { background:#f59e0b; color:#fff; }
  .status-approved { background:#10b981; color:#fff; }
  .clearfix::after { content:""; display:block; clear:both; }
  @media(max-width:480px){ .banner .actions{ float:none; margin-top:10px; } }
</style>
</head>
<body>

<header>üåü Task 1 ‚Äî Registration Job üåü</header>

<div class="banner clearfix" id="jobBanner">
  <strong>‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ú‡¶¨</strong>
  <div class="actions">
    <button class="btn btn-open" id="openLink">Open</button>
    <button class="btn btn-copy" id="copyLink">Copy</button>
  </div>
  <div style="clear:both"></div>
</div>

<div class="container" id="taskContainer">
  <h2>‚û°Ô∏è Task 1</h2>
  <p>‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡¶∞‡ßá ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶®‡¶ø‡¶ö‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞/‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶¶‡¶ø‡¶® ‚Äî ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ SUBMIT ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>

  <p class="note">‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶è‡¶¨‡¶Ç ‡¶™‡¶∞‡ßá ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶®‡¶∂‡¶ü ‡¶®‡¶ø‡¶®‡•§ (Before, After)</p>

  <label for="beforeScreenshot">Before Registration Screenshot</label>
  <input type="file" id="beforeScreenshot" accept="image/*">

  <label for="afterScreenshot">After Registration Screenshot</label>
  <input type="file" id="afterScreenshot" accept="image/*">

  <label for="contactInfo">Your number or email</label>
  <input type="text" id="contactInfo" placeholder="017xxxxxxxx or your@email.com">

  <div class="payline">Reward: <strong>5 Tk</strong></div>

  <button id="submitTask" class="submit-btn">SUBMIT</button>

  <div id="messages">
    <p class="success" id="successMsg" style="display:none"></p>
    <p class="error" id="errorMsg" style="display:none"></p>
    <p id="statusText" style="margin-top:10px;"></p>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
/* ---------- CONFIG ---------- */
const registrationURL = "https://otieu.com/4/10007498"; // <<== ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶≤‡¶ø‡¶Ç‡¶ï

const firebaseConfig = {
  apiKey: "AIzaSyBEbzvJ5asGNPp85_Uyvk1N_TCjIBfECXY",
  authDomain: "studentbestincome.firebaseapp.com",
  databaseURL: "https://studentbestincome-default-rtdb.firebaseio.com",
  projectId: "studentbestincome",
  storageBucket: "studentbestincome.firebasestorage.app",
  messagingSenderId: "261636758539",
  appId: "1:261636758539:web:faea7afabe319a53117b0e",
  measurementId: "G-6L77EJ7MJF"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

/* ---------- UI elems ---------- */
const openLinkBtn = document.getElementById('openLink');
const copyLinkBtn = document.getElementById('copyLink');
const beforeInput = document.getElementById('beforeScreenshot');
const afterInput = document.getElementById('afterScreenshot');
const contactInput = document.getElementById('contactInfo');
const submitBtn = document.getElementById('submitTask');
const successMsg = document.getElementById('successMsg');
const errorMsg = document.getElementById('errorMsg');
const statusText = document.getElementById('statusText');

/* ---------- Banner actions ---------- */
openLinkBtn.addEventListener('click', ()=> {
  window.open(registrationURL, "_blank");
});
copyLinkBtn.addEventListener('click', async ()=> {
  try {
    await navigator.clipboard.writeText(registrationURL);
    alert('Link copied to clipboard!');
  } catch(e) {
    // fallback
    prompt("Copy this link:", registrationURL);
  }
});

/* ---------- Helpers ---------- */
function showSuccess(text){
  successMsg.style.display = 'block';
  successMsg.innerText = text;
  errorMsg.style.display = 'none';
}
function showError(text){
  errorMsg.style.display = 'block';
  errorMsg.innerText = text;
  successMsg.style.display = 'none';
}
function setPendingUI(){
  submitBtn.disabled = true;
  submitBtn.innerText = "Pending Review ‚è≥";
  statusText.innerHTML = '<span class="status-badge status-pending">Pending Review ‚è≥</span>';
}
function setApprovedUI(){
  submitBtn.disabled = true;
  submitBtn.innerText = "Approved ‚úÖ";
  statusText.innerHTML = '<span class="status-badge status-approved">Approved ‚úÖ</span>';
}

/* ---------- Auth & initial check ---------- */
let currentUser = null;
auth.onAuthStateChanged(user => {
  currentUser = user;
  // reset messages
  successMsg.style.display = 'none';
  errorMsg.style.display = 'none';
  statusText.innerHTML = '';

  if(!user){
    showError('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!');
    submitBtn.disabled = true;
    return;
  }

  // check user's task1 status
  db.ref('users/' + user.uid + '/tasks/task1').once('value').then(snap=>{
    const val = snap.val();
    if(val === 'pending'){
      setPendingUI();
      showSuccess('‡¶Ü‡¶™‡¶®‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶á ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§');
    } else if(val === 'approved'){
      setApprovedUI();
      showSuccess('‡¶Ü‡¶™‡¶®‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶á ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶® ‡¶è‡¶¨‡¶Ç ‡¶™‡ßÅ‡¶∞‡¶∏‡ßç‡¶ï‡¶æ‡¶∞ ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®‡•§');
    } else {
      // allow submission
      submitBtn.disabled = false;
      submitBtn.innerText = 'SUBMIT';
    }
  }).catch(err=>{
    console.error(err);
  });
});

/* ---------- Submit handler ---------- */
submitBtn.addEventListener('click', async () => {
  // clear messages
  successMsg.style.display = 'none';
  errorMsg.style.display = 'none';
  statusText.innerHTML = '';

  if(!currentUser){
    showError('‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!');
    return;
  }

  const beforeFile = beforeInput.files[0];
  const afterFile = afterInput.files[0];
  const contact = contactInput.value.trim();

  if(!beforeFile || !afterFile || !contact){
    showError('‡¶∏‡¶¨ ‡¶´‡¶ø‡¶≤‡ßç‡¶° ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®!');
    return;
  }

  // Final check: prevent duplicate submission (race condition)
  const taskStatusSnap = await db.ref('users/' + currentUser.uid + '/tasks/task1').once('value');
  const existingStatus = taskStatusSnap.val();
  if(existingStatus === 'pending' || existingStatus === 'approved'){
    if(existingStatus === 'pending'){
      setPendingUI();
      showSuccess('‡¶Ü‡¶™‡¶®‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶á ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§');
    } else {
      setApprovedUI();
      showSuccess('‡¶Ü‡¶™‡¶®‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶á ‡¶ü‡¶æ‡¶∏‡ßç‡¶ï ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§');
    }
    return;
  }

  submitBtn.disabled = true;
  submitBtn.innerText = 'Uploading...';

  try {
    // upload files
    const timestamp = Date.now();
    const beforeRef = storage.ref('tasks/' + currentUser.uid + '/task1_before_' + timestamp);
    const afterRef = storage.ref('tasks/' + currentUser.uid + '/task1_after_' + timestamp);

    const beforeSnap = await beforeRef.put(beforeFile);
    const afterSnap = await afterRef.put(afterFile);

    const beforeURL = await beforeSnap.ref.getDownloadURL();
    const afterURL = await afterSnap.ref.getDownloadURL();

    // create submission
    const submissionKey = db.ref('taskSubmissions').push().key;
    const submissionData = {
      uid: currentUser.uid,
      taskId: 'task1',
      beforeScreenshot: beforeURL,
      afterScreenshot: afterURL,
      contact: contact,
      status: 'pending',
      reward: 5,
      submittedAt: Date.now()
    };

    const updates = {};
    updates['/taskSubmissions/' + submissionKey] = submissionData;
    updates['/users/' + currentUser.uid + '/tasks/task1'] = 'pending';
    // Optionally keep a reference for user's submissions
    updates['/users/' + currentUser.uid + '/submissions/' + submissionKey] = {
      taskId: 'task1',
      status: 'pending',
      submittedAt: Date.now()
    };

    await db.ref().update(updates);

    showSuccess('‚úÖ Submitted! Waiting for admin approval.');
    setPendingUI();

  } catch (err) {
    console.error(err);
    showError('‚ùå Error: ' + err.message);
    submitBtn.disabled = false;
    submitBtn.innerText = 'SUBMIT';
  }
});
</script>

</body>
</html>
