<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verify Account - Student Best Income</title>
<style>
body { font-family: Arial; background:#f0f9ff; padding:20px; text-align:center;}
.container { background:#e0f2fe; padding:20px; border-radius:10px; display:inline-block;}
input, button { padding:10px; margin:5px; width:90%; max-width:300px;}
button { cursor:pointer; }
.success { color:green; font-weight:bold; }
.error { color:red; font-weight:bold; }
</style>
</head>
<body>

<h2>ğŸŒŸ Verify Account ğŸŒŸ</h2>
<div class="container">
  <p id="statusMessage">Loading...</p>

  <div id="verifyForm" style="display:none;">
    <input type="file" id="screenshot" accept="image/*"><br>
    <input type="text" id="userNumber" placeholder="Your number or email"><br>
    <input type="text" id="txnId" placeholder="Transaction ID"><br>
    <button id="submitVerify">SUBMIT</button>
    <p class="success" id="successMsg"></p>
    <p class="error" id="errorMsg"></p>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBEbzvJ5asGNPp85_Uyvk1N_TCjIBfECXY",
  authDomain: "studentbestincome.firebaseapp.com",
  databaseURL: "https://studentbestincome-default-rtdb.firebaseio.com",
  projectId: "studentbestincome",
  storageBucket: "studentbestincome.firebasestorage.app",
  messagingSenderId: "261636758539",
  appId: "1:261636758539:web:faea7afabe319a53117b0e",
  measurementId: "G-6L77EJ7MJF"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

// DOM Elements
const statusMessage = document.getElementById('statusMessage');
const verifyForm = document.getElementById('verifyForm');
const submitBtn = document.getElementById('submitVerify');
const screenshotInput = document.getElementById('screenshot');
const userNumberInput = document.getElementById('userNumber');
const txnIdInput = document.getElementById('txnId');
const successMsg = document.getElementById('successMsg');
const errorMsg = document.getElementById('errorMsg');

auth.onAuthStateChanged(user => {
  if(!user){
    statusMessage.innerText = 'âš ï¸ Please login first';
    verifyForm.style.display = 'none';
    return;
  }

  // Check if user already submitted
  db.ref('users/' + user.uid + '/verify_requests').once('value', snapshot => {
    if(snapshot.exists()){
      statusMessage.innerText = 'â³ Waiting for verification';
      verifyForm.style.display = 'none';
    } else {
      statusMessage.innerText = '';
      verifyForm.style.display = 'block';
    }
  });
});

submitBtn.addEventListener('click', ()=>{
  errorMsg.innerText = '';
  successMsg.innerText = '';

  const file = screenshotInput.files[0];
  const userNumber = userNumberInput.value.trim();
  const txnId = txnIdInput.value.trim();

  if(!file || !userNumber || !txnId){
    errorMsg.innerText = 'âŒ Please fill all fields and upload screenshot';
    return;
  }

  const user = auth.currentUser;
  const storageRef = storage.ref('verify_screenshots/' + user.uid + '_' + Date.now());

  storageRef.put(file).then(snapshot=>{
    snapshot.ref.getDownloadURL().then(url=>{
      const data = {
        userNumber,
        txnId,
        screenshotURL: url,
        status: 'pending',
        timestamp: Date.now()
      };

      // Save under user node
      db.ref('users/' + user.uid + '/verify_requests').set(data);
      // Also save under admin node
      db.ref('admin/verify_requests/' + user.uid).set({...data, userId: user.uid});

      successMsg.innerText = 'âœ… Verification request submitted';
      verifyForm.style.display = 'none';
      statusMessage.innerText = 'â³ Waiting for verification';
    });
  }).catch(err=>{
    errorMsg.innerText = 'âŒ Error: '+err;
  });
});
</script>

</body>
</html>
